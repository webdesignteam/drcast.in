<?phpdefined('BASEPATH') OR exit('No direct script access allowed');class Home extends CI_Controller {    public $variable = "Z1zrHom3TGtP5eaj";    function __construct() {        // Construct the parent class        parent::__construct();        // $this->load->model('CRUD');        date_default_timezone_set('Asia/Kolkata');        $this->load->model('User_model');		$this->load->helper('string');		$this->load->helper('url');		header('Access-Control-Allow-Origin: *');		header("Access-Control-Allow-Methods: GET, POST, OPTIONS, PUT, DELETE");		header("Access-Control-Request-Method: *");			header("Access-Control-Request-Headers: *");		header("Access-Control-Allow-Headers: Origin, Content-type, X-Auth-Token, Authorization");    }	//Authenication    public function User_Auth() {        if ($this->session->userdata('EMAIL') && $this->session->userdata('NAME')) {            return TRUE;            // print($this->session->userdata('NAME')); exit;        } else {            return FALSE;        }    }	//Logout    public function logout() {        $this->session->unset_userdata('EMAIL');		$this->session->unset_userdata('NAME');		$this->session->unset_userdata('MOBILE');		$this->session->sess_destroy();		redirect('/');    }	// Random String	public function generateRandomString($length = 32) {		$characters = '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ';		$charactersLength = strlen($characters);		$randomString = '';		for ($i = 0; $i < $length; $i++) {			$randomString .= $characters[rand(0, $charactersLength - 1)];		}		return $randomString;	}	public function index() {	    //$this->session->sess_destroy();		$data = array();		$where= "webinar_code = '$this->variable'";        $data['webinarinfo'] = $this->User_model->getData('webinar', $where);		//echo "<pre>"; print_r($data); exit;		$this->load->view('index',$data);    }    public function auth(){		 if($this->input->post('submit')) {		    //echo "<pre>"; print_r($_POST); exit;		    $objDate = new DateTime();		    date_default_timezone_set('Asia/Kolkata');		    $username = trim($this->input->post('username'), " ");		    $where = "user_email = '$username' AND user_webinarname = '$this->variable' OR user_mobilenumber = '$username' AND user_webinarname = '$this->variable'";		    //echo $where; exit;		    $isexist = $this->User_model->getData(TBLREG, $where);		    //print_r($isexist); exit;		    if($isexist) {		        //echo "In"; exit;		        $logdata = array('log_logCode'=>$this->generateRandomString(),'log_webinarname'=>$this->variable,'log_userCode'=>$isexist[0]['user_Code'],'log_loggedOn'=>$objDate->format('Y-m-d H:i:s'));				//echo "<pre>"; print_r($logdata); exit;				$this->User_model->insertData(TBLLOG, $logdata);				$sessiondata = array('CODE' => $isexist[0]['user_Code'], 'NAME' => $isexist[0]['user_fullname'], 'EMAIL' => $username,'CITY' => $isexist[0]['user_city'],'SPECIALITY' => $isexist[0]['user_speciality'],'MOBILE'=>$isexist[0]['user_mobilenumber'],'UserLoggedIn' => true);				$this->session->set_userdata($sessiondata);				$message = array('status' => 1, 'message' => "Logged In Successfully", 'result' => array());            }else{                //echo "Out"; exit;                if($this->input->post('webinar_login_type') == "Email"){                    //echo "Email"; exit;                    $sessiondata = array('EMAIL' => $username);                }                elseif($this->input->post('webinar_login_type') == "Mobile"){                    //echo "Mobile"; exit;                    $sessiondata = array('MOBILE' => $username);                    //print_r($sessiondata); exit;                }				$this->session->set_userdata($sessiondata);				$message = array('status' => 0, 'message' => "User doesn't exist", 'result' => array());            }			echo json_encode($message);		}else{			$this->load->view('index');		} 		//echo "In"; exit;	}	public function addUser(){		 if ($this->input->post('submit')) {			$objDate = new DateTime();			date_default_timezone_set('Asia/Kolkata'); 			$webinar_code = $this->variable;			$where= "webinar_code = '$this->variable'";			$data['webinarinfo'] = $this->User_model->getData('webinar', $where);			$fullname = trim($this->input->post('fullname'), " ");            $email = trim($this->input->post('email'), " ");            $mcinumber = trim($this->input->post('mcinumber'), " ");            $mobilenumber = trim($this->input->post('mobilenumber'), " ");            $city = trim($this->input->post('city'), " ");            $state = trim($this->input->post('state'), " ");            $speciality = trim($this->input->post('speciality'), " ");           	$password = strtoupper(random_string('nozero',8));   			if($data['webinarinfo'][0]['webinar_login_type'] == "Mobile"){           	    $where = array('user_mobilenumber' => $email,'user_webinarname'=> $webinar_code);               	}else{           	    $where = array('user_email' => $email,'user_webinarname'=> $webinar_code);               	}			$isexist = $this->User_model->isDataExist(TBLREG, $where);			$code = $this->generateRandomString();			if (!$isexist) {			    //echo "In"; exit;                $system_array=array(    							'user_Code'=>$code,    							'user_webinarname'=> $webinar_code,    							'user_fullname'=>$fullname,    							'user_email'=>$email,    		                    'user_mcinumber'=>$mcinumber,    		                    'user_mobilenumber'=>$mobilenumber,    		                    'user_password'=>$password,    		                    'user_city'=>$city,							    		                    'user_state'=>$state,							    		                    'user_speciality'=>$speciality,    		                    'user_createdON' => $objDate->format('Y-m-d H:i:s')    							);		    			$this->User_model->insertData(TBLREG, $system_array);    			$sessiondata = array('NAME' => $fullname, 'CODE' => $code);    			$this->session->set_userdata($sessiondata);    			$logdata = array('log_logCode'=>$this->generateRandomString(),'log_webinarname'=>$webinar_code,'log_userCode'=>$email,'log_loggedOn'=>$objDate->format('Y-m-d H:i:s'));    			//print_r($logdata); exit;			    $this->User_model->insertData(TBLLOG, $logdata);			    $message = array('status' => 1, 'message' => "User added successfully", 'result' => array());			}else{			    $sessiondata = array('NAME' => $fullname, 'CODE' => $code);			    $this->session->set_userdata($sessiondata);			    $message = array('status' => 0, 'message' => "User already registered", 'result' => array());			}			echo json_encode($message);		}else{			$this->load->view('index');		}   	}	public function check_availability_email(){        //echo "<pre>"; print_r($_POST); exit;		$email = $_POST['email'];		$where = "user_email = '$email' AND user_webinarname = '$this->variable'";		$data['check_availability'] = $this->User_model->getData(TBLREG, $where);		//print_r($data); exit;		if(empty($data['check_availability'])) {			echo 'true'; //exit;		}		else {			echo 'false'; //exit;		}    }    public function check_availability_mobilenumber(){        //echo "<pre>"; print_r($_POST); exit;		$mobile = $_POST['mobilenumber'];		$where = "user_mobilenumber = '$mobile' AND user_webinarname = '$this->variable'";		$data['check_availability'] = $this->User_model->getData(TBLREG, $where);		//print_r($data); exit;		if(empty($data['check_availability'])) {			echo 'true'; //exit;		}		else {			echo 'false'; //exit;		}    }    public function dashboard(){        $data = array();        $table = TBLQUERY;        $where= "Que_webinar = '$this->variable' AND Que_status = '1002'";        $data['pending_querys'] = $this->User_model->getCount($table, $where, '');        $table = TBLQUERY;        $where= "Que_webinar = '$this->variable' AND Que_status = '1001'";        $data['answered_querys'] = $this->User_model->getCount($table, $where, '');        $table = TBLQUERY;        $where= "Que_webinar = '$this->variable' AND Que_status != '1003'";        $data['total_querys'] = $this->User_model->getCount($table, $where, '');        $where= "webinar_code = '$this->variable'";        $data['webinarinfo'] = $this->User_model->getData('webinar', $where);        $webinar_code = $this->variable;        $sdatetime = $data['webinarinfo'][0]['webinar_start'];        // Convert datetime to Unix timestamp        $stimestamp = strtotime($sdatetime);        // Subtract time from datetime        $stime = $stimestamp - (0.5 * 60 * 60);        // Date and time after subtraction        $DATEFROM = $data['webinarinfo'][0]['webinar_date'].' '.date("H:i:s", $stime);        $tdatetime = $data['webinarinfo'][0]['webinar_end'];        // Convert datetime to Unix timestamp        $ttimestamp = strtotime($tdatetime);        // Subtract time from datetime        $ttime = $ttimestamp + (0.5 * 60 * 60);        // Date and time after subtraction        $DATETO = $data['webinarinfo'][0]['webinar_date'].' '.date("H:i:s", $ttime);        $table = TBLLOG;        $where = "log_webinarname = '$this->variable' AND log_loggedOn BETWEEN '$DATEFROM' AND '$DATETO'";        $data['loggedusers_count'] = $this->User_model->getCount($table, $where, 'log_userCode');        $table = TBLREG;        $where= "user_webinarname = '$this->variable'";        $data['participants_count'] = $this->User_model->getCount($table, $where, '');        //echo "<pre>"; print_r($data['loggedusers_count']); exit;        $this->load->view('dashboard', $data);    }	public function register() {		$data = array();		$where= "webinar_code = '$this->variable'";        $data['webinarinfo'] = $this->User_model->getData('webinar', $where);		$this->load->view('register', $data);    }	public function login() {		$data = array();		$where= "webinar_code = '$this->variable'";        $data['webinarinfo'] = $this->User_model->getData('webinar', $where);		$this->load->view('login', $data);     }    public function streaming() {        $data = array();        $objDate = new DateTime();	    date_default_timezone_set('Asia/Kolkata');		if ($this->User_Auth()) {} else {			redirect('/');		}		//Get User info		//echo $this->session->userdata('CODE');		$logdata = array('log_logCode'=>$this->generateRandomString(),'log_webinarname'=>$this->variable,'log_userCode'=>$this->session->userdata('CODE'),'log_loggedOn'=>$objDate->format('Y-m-d H:i:s'));		$this->User_model->insertData(TBLLOG, $logdata);	    $where= "webinar_code = '$this->variable'";        $data['webinarinfo'] = $this->User_model->getData('webinar', $where);        $webinar_code = $data['webinarinfo'][0]['webinar_code']; //exit;        //User Info        $code = $this->session->userdata('CODE');        $where2 = "user_Code = '$code'";        $data['userinfo'] = $this->User_model->getData('users', $where2);        $userid = $data['userinfo'][0]['user_autoID'];        $where1 = "user_autoID = '$userid' AND webinar_code = '$webinar_code'";        $data['poolinfo'] = $this->User_model->getData('pool', $where1);        //echo "<pre>"; print_r($data); exit;		$this->load->view('streaming', $data);     }    public function pool(){        //echo "<pre>"; print_r($_POST); exit;        $data = array();        $objDate = new DateTime();		date_default_timezone_set('Asia/Kolkata');         $code = $this->session->userdata('CODE'); //exit;        $poolcheckbox = $this->input->post('poolcheckbox');        //User Info        $where = "user_Code = '$code'";        $data['userinfo'] = $this->User_model->getData('users', $where);        //Get Webinar Info        $webinar_code = $this->variable;        $where1 = "webinar_code = '$webinar_code'";        $data['webinarinfo'] = $this->User_model->getData('webinar', $where1);        $add_pool = array(            'user_autoID' => $data['userinfo'][0]['user_autoID'],            'pool_code' => $this->generateRandomString(),            'webinar_code' => $data['webinarinfo'][0]['webinar_code'],            'pool_createdon' => $objDate->format('Y-m-d H:i:s'));           //echo "<pre>"; print_r($add_pool); exit;        $insert_pool = $this->User_model->insertData('pool', $add_pool);        foreach($poolcheckbox as $v):            $add_pool_results[] = array(            'pool_autoID' => $insert_pool,            'user_autoID' => $data['userinfo'][0]['user_autoID'],            'pool_results' => $v);         endforeach;        $insert_pool_results = $this->User_model->insert_batch('pool_results', $add_pool_results);        if($insert_pool_results){            $message =array('status'=>1,'message'=>'Submitted Successfully','result'=>[]);        }else{             $message =array('status'=>0,'message'=>'Error in Submission','result'=>[]);          }        echo json_encode($message);    }	public function submitquery(){		 if ($this->input->post('submit')) {		     $webinar_code = $this->variable;		    date_default_timezone_set('Asia/Kolkata');			$objDate = new DateTime();			$query = trim($this->input->post('query'), " ");            $name = trim($this->input->post('username'), " ");                       $system_array=array(							'Que_Code'=>$this->generateRandomString(),							'Que_webinar'=>$webinar_code,							'Que_Query'=>$query,							'Que_name'=>$name,							'Que_status'=>1002,		                    'Que_createdOn' => $objDate->format('Y-m-d H:i:s'));			$id = $this->User_model->insertData(TBLQUERY, $system_array);			if($id){				$message = array('status' => 1, 'message' => "Query Submitted successfully", 'result' => array());			}else{				$message = array('status' => 0, 'message' => "Couldn't submit your query", 'result' => array());			}				echo json_encode($message);		}else{			$this->load->view('streaming');		}   	}	public function participants() {	    $webinar_code = $this->variable;	    //echo $webinar_code; exit;	    $where= "webinar_code = '$this->variable'";        $data['webinarinfo'] = $this->User_model->getData('webinar', $where);		$data['participants'] = $this->User_model->getParticipants($webinar_code);		$this->load->view('participants_view',$data);     }	public function queries() {		    $webinar_code = $this->variable;	    //echo $webinar_code; exit;	    $where= "webinar_code = '$this->variable'";        $data['webinarinfo'] = $this->User_model->getData('webinar', $where);		$data['activity'] = $this->User_model->getQueries($webinar_code);		$data['query'] = $this->User_model->getQuery($webinar_code);		//echo "<pre>"; print_r($data); exit;		$this->load->view('queries_view',$data);     }	public function updatequery(){		 if ($this->input->post('submit')) {			    //echo "Submit"; exit;			$objDate = new DateTime();			$code = trim($this->input->post('code'), " ");			$where = array('Que_Code' => $code);			$updatearray = array('Que_status'=>1001);			$this->User_model->updateData(TBLQUERY, $updatearray,$where);						redirect('queries');		}		if ($this->input->post('remove')) {				    //echo "Remove"; exit;			$objDate = new DateTime();			$code = trim($this->input->post('code'), " ");			$where = array('Que_Code' => $code);			$updatearray = array('Que_status'=>1003);			$this->User_model->updateData(TBLQUERY, $updatearray,$where);						redirect('queries');		}		if($this->input->post('unanswered')) {		    $objDate = new DateTime();			$code = trim($this->input->post('code'), " ");			$where = array('Que_Code' => $code);			$updatearray = array('Que_status'=>1002);			$this->User_model->updateData(TBLQUERY, $updatearray,$where);						redirect('queries');		}		else{		    $webinar_code = $this->variable;			$data['activity'] = $this->User_model->getQueries($webinar_code);			$this->load->view('queries_view',$data);		}   	}	public function loggedusers() {	    date_default_timezone_set('Asia/Kolkata');	    $where= "webinar_code = '$this->variable'";        $data['webinarinfo'] = $this->User_model->getData('webinar', $where);        $webinar_code = $this->variable;        $webinar_login_type = $data['webinarinfo'][0]['webinar_login_type'];        $sdatetime = $data['webinarinfo'][0]['webinar_start'];        // Convert datetime to Unix timestamp        $stimestamp = strtotime($sdatetime);        // Subtract time from datetime        $stime = $stimestamp - (0.5 * 60 * 60);        // Date and time after subtraction        $DATEFROM = $data['webinarinfo'][0]['webinar_date'].' '.date("H:i:s", $stime);        $tdatetime = $data['webinarinfo'][0]['webinar_end'];        // Convert datetime to Unix timestamp        $ttimestamp = strtotime($tdatetime);        // Subtract time from datetime        $ttime = $ttimestamp + (0.5 * 60 * 60);        // Date and time after subtraction        $DATETO = $data['webinarinfo'][0]['webinar_date'].' '.date("H:i:s", $ttime);		$data['loggedparticipants'] = $this->User_model->getLoggedUsers($webinar_code, $DATEFROM, $DATETO);		//echo "<pre>"; print_r($data['loggedparticipants']); exit;		$this->load->view('logger_view',$data);    }    public function poll_results() {        // echo "Test";        $webinar_code = $this->variable;	    //echo $webinar_code; exit;	    $where= "webinar_code = '$this->variable'";        $data['webinarinfo'] = $this->User_model->getData('webinar', $where);        $data['pollresults'] = $this->User_model->getpollresults($webinar_code);        $data['pollcount'] = $this->User_model->getpollcount($webinar_code);        //echo "<pre>"; print_r($data); exit;        $this->load->view('poll_results', $data);    }    public function check_url($url) {        $ch = curl_init();        curl_setopt($ch, CURLOPT_URL, $url);        curl_setopt($ch, CURLOPT_HEADER, 1);        curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);        $data = curl_exec($ch);        $headers = curl_getinfo($ch);        curl_close($ch);        // print_r($headers['http_code']);        return $headers['http_code'];    }}